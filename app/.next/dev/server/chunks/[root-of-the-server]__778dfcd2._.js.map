{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/dmakowski/git_priv/kubevista/app/lib/auth/github-app.ts"],"sourcesContent":["import { App } from '@octokit/app'\n\n// GitHub App authentication (not OAuth)\n// This allows users to grant access to specific repositories only\nexport class GitHubAppAuth {\n  private app: App | null = null\n\n  constructor() {\n    const appId = process.env.GITHUB_APP_ID\n    const privateKey = process.env.GITHUB_APP_PRIVATE_KEY\n    const clientId = process.env.GITHUB_APP_CLIENT_ID\n    const clientSecret = process.env.GITHUB_APP_CLIENT_SECRET\n\n    if (!appId || !privateKey || !clientId || !clientSecret) {\n      console.warn('GitHub App credentials not configured')\n      return\n    }\n\n    this.app = new App({\n      appId,\n      privateKey: privateKey.replace(/\\\\n/g, '\\n'), // Handle escaped newlines\n      oauth: {\n        clientId,\n        clientSecret,\n      },\n    })\n  }\n\n  isConfigured(): boolean {\n    return this.app !== null\n  }\n\n  getApp(): App {\n    if (!this.app) {\n      throw new Error('GitHub App not configured')\n    }\n    return this.app\n  }\n\n  // Get OAuth URL for user to install the app\n  getInstallationUrl(): string {\n    const clientId = process.env.GITHUB_APP_CLIENT_ID\n    if (!clientId) {\n      throw new Error('GITHUB_APP_CLIENT_ID not configured')\n    }\n    return `https://github.com/apps/${process.env.GITHUB_APP_SLUG}/installations/new`\n  }\n\n  // Exchange code for user access token (after OAuth callback)\n  async exchangeCode(code: string): Promise<{\n    token: string\n    expiresAt: string\n    refreshToken: string\n    refreshTokenExpiresAt: string\n  }> {\n    if (!this.app) {\n      throw new Error('GitHub App not configured')\n    }\n\n    const result = await this.app.oauth.createToken({\n      code,\n    })\n\n    return {\n      token: result.authentication.token,\n      expiresAt: result.authentication.expiresAt || '',\n      refreshToken: result.authentication.refreshToken || '',\n      refreshTokenExpiresAt: result.authentication.refreshTokenExpiresAt || '',\n    }\n  }\n\n  // Refresh an expired user access token\n  async refreshToken(refreshToken: string): Promise<{\n    token: string\n    expiresAt: string\n    refreshToken: string\n    refreshTokenExpiresAt: string\n  }> {\n    if (!this.app) {\n      throw new Error('GitHub App not configured')\n    }\n\n    const result = await this.app.oauth.refreshToken({\n      refreshToken,\n    })\n\n    return {\n      token: result.authentication.token,\n      expiresAt: result.authentication.expiresAt || '',\n      refreshToken: result.authentication.refreshToken || '',\n      refreshTokenExpiresAt: result.authentication.refreshTokenExpiresAt || '',\n    }\n  }\n\n  // Get installation token for accessing repositories\n  async getInstallationToken(installationId: number): Promise<string> {\n    if (!this.app) {\n      throw new Error('GitHub App not configured')\n    }\n\n    const octokit = await this.app.getInstallationOctokit(installationId)\n    // @ts-expect-error - Octokit types are complex\n    const { data } = await octokit.rest.apps.createInstallationAccessToken({\n      installation_id: installationId,\n    })\n\n    return data.token\n  }\n\n  // Get user's installations (which orgs/accounts have the app installed)\n  async getUserInstallations(userToken: string): Promise<any[]> {\n    if (!this.app) {\n      throw new Error('GitHub App not configured')\n    }\n\n    const { Octokit } = await import('@octokit/rest')\n    const octokit = new Octokit({ auth: userToken })\n\n    const { data } = await octokit.rest.apps.listInstallationsForAuthenticatedUser()\n    return data.installations\n  }\n}\n\nexport const githubApp = new GitHubAppAuth()\n"],"names":[],"mappings":";;;;;;AAAA;;AAIO,MAAM;IACH,MAAkB,KAAI;IAE9B,aAAc;QACZ,MAAM,QAAQ,QAAQ,GAAG,CAAC,aAAa;QACvC,MAAM,aAAa,QAAQ,GAAG,CAAC,sBAAsB;QACrD,MAAM,WAAW,QAAQ,GAAG,CAAC,oBAAoB;QACjD,MAAM,eAAe,QAAQ,GAAG,CAAC,wBAAwB;QAEzD,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC,YAAY,CAAC,cAAc;YACvD,QAAQ,IAAI,CAAC;YACb;QACF;QAEA,IAAI,CAAC,GAAG,GAAG,IAAI,kKAAG,CAAC;YACjB;YACA,YAAY,WAAW,OAAO,CAAC,QAAQ;YACvC,OAAO;gBACL;gBACA;YACF;QACF;IACF;IAEA,eAAwB;QACtB,OAAO,IAAI,CAAC,GAAG,KAAK;IACtB;IAEA,SAAc;QACZ,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACb,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,IAAI,CAAC,GAAG;IACjB;IAEA,4CAA4C;IAC5C,qBAA6B;QAC3B,MAAM,WAAW,QAAQ,GAAG,CAAC,oBAAoB;QACjD,IAAI,CAAC,UAAU;YACb,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,CAAC,wBAAwB,EAAE,QAAQ,GAAG,CAAC,eAAe,CAAC,kBAAkB,CAAC;IACnF;IAEA,6DAA6D;IAC7D,MAAM,aAAa,IAAY,EAK5B;QACD,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACb,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,SAAS,MAAM,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,WAAW,CAAC;YAC9C;QACF;QAEA,OAAO;YACL,OAAO,OAAO,cAAc,CAAC,KAAK;YAClC,WAAW,OAAO,cAAc,CAAC,SAAS,IAAI;YAC9C,cAAc,OAAO,cAAc,CAAC,YAAY,IAAI;YACpD,uBAAuB,OAAO,cAAc,CAAC,qBAAqB,IAAI;QACxE;IACF;IAEA,uCAAuC;IACvC,MAAM,aAAa,YAAoB,EAKpC;QACD,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACb,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,SAAS,MAAM,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,YAAY,CAAC;YAC/C;QACF;QAEA,OAAO;YACL,OAAO,OAAO,cAAc,CAAC,KAAK;YAClC,WAAW,OAAO,cAAc,CAAC,SAAS,IAAI;YAC9C,cAAc,OAAO,cAAc,CAAC,YAAY,IAAI;YACpD,uBAAuB,OAAO,cAAc,CAAC,qBAAqB,IAAI;QACxE;IACF;IAEA,oDAAoD;IACpD,MAAM,qBAAqB,cAAsB,EAAmB;QAClE,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACb,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,UAAU,MAAM,IAAI,CAAC,GAAG,CAAC,sBAAsB,CAAC;QACtD,+CAA+C;QAC/C,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,IAAI,CAAC,IAAI,CAAC,6BAA6B,CAAC;YACrE,iBAAiB;QACnB;QAEA,OAAO,KAAK,KAAK;IACnB;IAEA,wEAAwE;IACxE,MAAM,qBAAqB,SAAiB,EAAkB;QAC5D,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE;YACb,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,EAAE,OAAO,EAAE,GAAG;QACpB,MAAM,UAAU,IAAI,QAAQ;YAAE,MAAM;QAAU;QAE9C,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,IAAI,CAAC,IAAI,CAAC,qCAAqC;QAC9E,OAAO,KAAK,aAAa;IAC3B;AACF;AAEO,MAAM,YAAY,IAAI"}},
    {"offset": {"line": 157, "column": 0}, "map": {"version":3,"sources":["file:///Users/dmakowski/git_priv/kubevista/app/app/api/github-app/installations/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { githubApp } from '@/lib/auth/github-app'\nimport { cookies } from 'next/headers'\n\nexport async function GET() {\n  try {\n    const cookieStore = await cookies()\n    const token = cookieStore.get('github_app_token')?.value\n\n    if (!token) {\n      return NextResponse.json({ error: 'Not authenticated' }, { status: 401 })\n    }\n\n    // Get user's installations\n    const installations = await githubApp.getUserInstallations(token)\n\n    // Get repositories for each installation\n    const { Octokit } = await import('@octokit/rest')\n    const octokit = new Octokit({ auth: token })\n\n    const installationsWithRepos = await Promise.all(\n      installations.map(async (installation) => {\n        try {\n          const { data } = await octokit.rest.apps.listInstallationReposForAuthenticatedUser({\n            installation_id: installation.id,\n          })\n\n          return {\n            id: installation.id,\n            account: {\n              login: installation.account?.login,\n              avatar_url: installation.account?.avatar_url,\n              type: installation.account?.type,\n            },\n            repositories: data.repositories.map((repo: any) => ({\n              id: repo.id,\n              name: repo.name,\n              full_name: repo.full_name,\n              owner: repo.owner.login,\n              private: repo.private,\n              default_branch: repo.default_branch,\n            })),\n          }\n        } catch (error) {\n          console.error(`Error fetching repos for installation ${installation.id}:`, error)\n          return {\n            id: installation.id,\n            account: installation.account,\n            repositories: [],\n          }\n        }\n      })\n    )\n\n    return NextResponse.json(installationsWithRepos)\n  } catch (error) {\n    console.error('Error fetching installations:', error)\n    return NextResponse.json(\n      { error: 'Failed to fetch installations' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,qBAAqB;QAEnD,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,2BAA2B;QAC3B,MAAM,gBAAgB,MAAM,kJAAS,CAAC,oBAAoB,CAAC;QAE3D,yCAAyC;QACzC,MAAM,EAAE,OAAO,EAAE,GAAG;QACpB,MAAM,UAAU,IAAI,QAAQ;YAAE,MAAM;QAAM;QAE1C,MAAM,yBAAyB,MAAM,QAAQ,GAAG,CAC9C,cAAc,GAAG,CAAC,OAAO;YACvB,IAAI;gBACF,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,IAAI,CAAC,IAAI,CAAC,yCAAyC,CAAC;oBACjF,iBAAiB,aAAa,EAAE;gBAClC;gBAEA,OAAO;oBACL,IAAI,aAAa,EAAE;oBACnB,SAAS;wBACP,OAAO,aAAa,OAAO,EAAE;wBAC7B,YAAY,aAAa,OAAO,EAAE;wBAClC,MAAM,aAAa,OAAO,EAAE;oBAC9B;oBACA,cAAc,KAAK,YAAY,CAAC,GAAG,CAAC,CAAC,OAAc,CAAC;4BAClD,IAAI,KAAK,EAAE;4BACX,MAAM,KAAK,IAAI;4BACf,WAAW,KAAK,SAAS;4BACzB,OAAO,KAAK,KAAK,CAAC,KAAK;4BACvB,SAAS,KAAK,OAAO;4BACrB,gBAAgB,KAAK,cAAc;wBACrC,CAAC;gBACH;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,CAAC,sCAAsC,EAAE,aAAa,EAAE,CAAC,CAAC,CAAC,EAAE;gBAC3E,OAAO;oBACL,IAAI,aAAa,EAAE;oBACnB,SAAS,aAAa,OAAO;oBAC7B,cAAc,EAAE;gBAClB;YACF;QACF;QAGF,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAgC,GACzC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}