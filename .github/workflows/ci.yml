name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: Install dependencies
        run: cd app && npm ci

      - name: Run ESLint
        run: cd app && npm run lint

      - name: Create lint summary
        if: always()
        run: |
          echo "## ðŸ“ ESLint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "âœ… **No linting errors found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Linting errors detected**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files checked: TypeScript and TSX files in app/" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: Install dependencies
        run: cd app && npm ci

      - name: Run TypeScript type check
        run: cd app && npm run type-check

      - name: Create type check summary
        if: always()
        run: |
          echo "## ðŸ”· TypeScript Type Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "âœ… **No type errors found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Type errors detected**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TypeScript version: 5.9.3" >> $GITHUB_STEP_SUMMARY

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [type-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: Install dependencies
        run: cd app && npm ci

      - name: Run unit tests
        id: test
        run: |
          cd app && npm run test:coverage -- --reporter=verbose --reporter=json --outputFile=../test-results.json
        continue-on-error: true

      - name: Create test summary
        if: always()
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.json ]; then
            TEST_COUNT=$(jq '.numTotalTests' test-results.json 2>/dev/null || echo "0")
            PASS_COUNT=$(jq '.numPassedTests' test-results.json 2>/dev/null || echo "0")
            FAIL_COUNT=$(jq '.numFailedTests' test-results.json 2>/dev/null || echo "0")
            SKIP_COUNT=$(jq '.numPendingTests' test-results.json 2>/dev/null || echo "0")

            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASS_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAIL_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIP_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TEST_COUNT** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… **All tests passed**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **Tests completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "- 53 test files" >> $GITHUB_STEP_SUMMARY
            echo "- ~1390 tests" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage summary
          if [ -f app/coverage/coverage-summary.json ]; then
            echo "### ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            STATEMENTS=$(jq '.total.statements.pct' app/coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' app/coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' app/coverage/coverage-summary.json)
            LINES=$(jq '.total.lines.pct' app/coverage/coverage-summary.json)

            echo "| Metric | Coverage | Threshold |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% | 75% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% | 59% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% | 85% |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% | 75% |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: app/coverage
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: Install dependencies
        run: cd app && npm ci

      - name: Run npm audit
        id: audit
        run: |
          cd app && npm audit --audit-level=moderate --json > ../audit-results.json || true
        continue-on-error: true

      - name: Check for console.log statements
        id: console-check
        run: |
          CONSOLE_COUNT=$(grep -r "console\.log" app/app app/lib --include="*.ts" --include="*.tsx" --exclude-dir=node_modules | wc -l || echo "0")
          echo "console_count=$CONSOLE_COUNT" >> $GITHUB_OUTPUT
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            grep -r "console\.log" app/app app/lib --include="*.ts" --include="*.tsx" --exclude-dir=node_modules > console-log-findings.txt || true
          fi
        continue-on-error: true

      - name: Create security scan summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # npm audit results
          if [ -f audit-results.json ]; then
            VULNERABILITIES=$(jq '.metadata.vulnerabilities | to_entries | map(select(.value > 0)) | length' audit-results.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)

            echo "### ðŸ“¦ Dependency Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âš ï¸ **Warning**: Critical or High severity vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No critical or high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ðŸ“¦ Dependency Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # console.log check
          CONSOLE_COUNT="${{ steps.console-check.outputs.console_count }}"
          echo "### ðŸ–¨ï¸ Console.log Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $CONSOLE_COUNT console.log statements" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please use the logger utility instead of console.log" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No console.log statements found" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [security-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: Install dependencies
        run: cd app && npm ci

      - name: Build application
        id: build
        run: |
          cd app && npm run build 2>&1 | tee ../build-output.txt

      - name: Create build summary
        if: always()
        run: |
          echo "## ðŸ“¦ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d app/.next ]; then
            BUILD_SIZE=$(du -sh app/.next | cut -f1)
            echo "âœ… **Build completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Build size | $BUILD_SIZE |" >> $GITHUB_STEP_SUMMARY
            echo "| Framework | Next.js 16.0.5 |" >> $GITHUB_STEP_SUMMARY
            echo "| React | 19.2.0 |" >> $GITHUB_STEP_SUMMARY
            echo "| TypeScript | 5.9.3 |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract route info from build output
            if [ -f build-output.txt ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>View build details</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -A 50 "Route (app)" build-output.txt | head -50 >> $GITHUB_STEP_SUMMARY || echo "Build output details available in logs" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Build failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: |
            app/.next
            app/public
            app/package.json
            app/package-lock.json
          retention-days: 7
