#!/bin/bash

# Pre-commit hook with AI integration
# Runs before each commit to ensure code quality

set -e

echo "ğŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks failed
FAILED=0

# 1. Lint check
echo ""
echo "ğŸ“ Running ESLint..."
if (cd app && npm run lint --silent); then
    echo -e "${GREEN}âœ… Lint passed${NC}"
else
    echo -e "${RED}âŒ Lint failed${NC}"
    echo -e "${YELLOW}ğŸ’¡ Run: npm run lint:fix${NC}"
    FAILED=1
fi

# 2. Type check
echo ""
echo "ğŸ”· Running TypeScript type check..."
if (cd app && npm run type-check --silent); then
    echo -e "${GREEN}âœ… Type check passed${NC}"
else
    echo -e "${RED}âŒ Type check failed${NC}"
    echo -e "${YELLOW}ğŸ’¡ Fix TypeScript errors before committing${NC}"
    FAILED=1
fi

# 3. Unit tests
echo ""
echo "ğŸ§ª Running unit tests..."
if (cd app && npm run test --silent); then
    echo -e "${GREEN}âœ… Tests passed${NC}"
else
    echo -e "${RED}âŒ Tests failed${NC}"
    echo -e "${YELLOW}ğŸ’¡ Fix failing tests before committing${NC}"
    FAILED=1
fi

# 4. Check for console.log (warning only)
echo ""
echo "ğŸ” Checking for console.log statements..."
if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -n 'console\.log' 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸  Found console.log statements${NC}"
    echo -e "${YELLOW}ğŸ’¡ Consider removing or replacing with console.error/warn${NC}"
    # Don't fail, just warn
fi

# 5. Check for TODO comments (warning only)
echo ""
echo "ğŸ“‹ Checking for TODO comments..."
TODO_COUNT=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -c 'TODO\|FIXME' 2>/dev/null | awk -F: '{sum+=$2} END {print sum}' || echo "0")
if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  Found $TODO_COUNT TODO/FIXME comments${NC}"
    echo -e "${YELLOW}ğŸ’¡ Consider addressing or tracking in issues${NC}"
fi

# 6. Check for large files (>1MB)
echo ""
echo "ğŸ“¦ Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -l 2>/dev/null | awk '$5 > 1048576 {print $9, "(" $5/1048576 "MB)"}')
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Large files detected:${NC}"
    echo "$LARGE_FILES"
    echo -e "${YELLOW}ğŸ’¡ Consider using Git LFS or excluding from repo${NC}"
fi

# 7. AI Code Review (optional - commented out by default)
# Uncomment to enable AI review before each commit
# echo ""
# echo "ğŸ¤– Running AI code review..."
# echo -e "${YELLOW}ğŸ’¡ To enable AI review, uncomment this section in .githooks/pre-commit${NC}"
#
# # Get list of changed files
# CHANGED_FILES=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' || true)
#
# if [ -n "$CHANGED_FILES" ]; then
#     echo "Changed files:"
#     echo "$CHANGED_FILES"
#
#     # Here you would call your AI code review
#     # For example, using Claude Code or another AI service
#     #
#     # Example prompt:
#     # "Review the following code changes for:
#     # - Architecture violations (K8s client in client components)
#     # - Security issues (hardcoded secrets, localStorage auth)
#     # - TypeScript issues (any types, missing error handling)
#     # - Missing tests
#     #
#     # Files: $CHANGED_FILES"
# fi

# Final summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ… All checks passed! Ready to commit.${NC}"
    exit 0
else
    echo -e "${RED}âŒ Some checks failed. Please fix before committing.${NC}"
    echo ""
    echo "To bypass (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
