#!/bin/bash

# Commit message hook
# Validates commit message format

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üìù Validating commit message..."

# Check commit message format
# Format: type(scope): description
# Types: feat, fix, docs, style, refactor, perf, test, chore, security

PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore|security)(\(.+\))?: .{10,}"

if ! echo "$COMMIT_MSG" | grep -Eq "$PATTERN"; then
    echo -e "${RED}‚ùå Invalid commit message format${NC}"
    echo ""
    echo "Commit message format:"
    echo "  type(scope): description"
    echo ""
    echo "Types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style (formatting)"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvement"
    echo "  test     - Test changes"
    echo "  chore    - Maintenance tasks"
    echo "  security - Security fixes"
    echo ""
    echo "Examples:"
    echo "  feat(services): add support for Kubernetes services"
    echo "  fix(logs): resolve race condition in pod logs"
    echo "  docs(readme): update installation instructions"
    echo ""
    echo "Your message:"
    echo "  $COMMIT_MSG"
    echo ""
    exit 1
fi

# Check message length
MSG_LENGTH=${#COMMIT_MSG}
if [ $MSG_LENGTH -lt 10 ]; then
    echo -e "${RED}‚ùå Commit message too short (minimum 10 characters)${NC}"
    exit 1
fi

if [ $MSG_LENGTH -gt 100 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Commit message is long (${MSG_LENGTH} characters)${NC}"
    echo -e "${YELLOW}üí° Consider keeping the summary line under 72 characters${NC}"
    # Don't fail, just warn
fi

# Check for WIP commits
if echo "$COMMIT_MSG" | grep -Eq "^(wip|WIP|work in progress)"; then
    echo -e "${YELLOW}‚ö†Ô∏è  WIP commit detected${NC}"
    echo -e "${YELLOW}üí° Remember to squash WIP commits before merging${NC}"
fi

echo -e "${GREEN}‚úÖ Commit message valid${NC}"
exit 0
